name: Update

on:
  schedule:
    - cron: "0 17 * * 5"  # Every Saturday 00:00 UTC+7
  push:
    branches:
      - main
    paths:
      - ".github/workflows/weekly.yml"
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/weekly.yml"

permissions:
  contents: read

jobs:
  check:
    name: Check updates on ${{ matrix.fedora }}
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        fedora:
          - lightblue
          - lightblue-hyprland
          - lightblue-cosmic
          - lightblue-intel
          - lightblue-hyprland-intel
          - lightblue-cosmic-intel
    container:
      image: ghcr.io/${{ github.repository_owner }}/${{ matrix.fedora }}
    outputs:
      has_updates: ${{ steps.upgrades.outputs.has_updates }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Refresh metadata
        run: dnf -y --refresh makecache

      - name: Setup repositories
        shell: bash
        run: |
          set -euo pipefail

          rpm --import https://packages.microsoft.com/keys/microsoft.asc
          rpm -v --import https://yum.tableplus.com/apt.tableplus.com.gpg.key

          cp ./files/system/etc/yum.repos.d/* /etc/yum.repos.d/

          dnf config-manager addrepo --overwrite \
            --from-repofile=https://yum.tableplus.com/rpm/x86_64/tableplus.repo

          dnf install -y --nogpgcheck --repofrompath \
            'terra,https://repos.fyralabs.com/terra$releasever' terra-release

          dnf -y copr enable dejan/lazygit
          dnf -y copr enable lihaohong/yazi
          dnf -y copr enable rivenirvana/lazydocker
          dnf -y copr enable solopasha/hyprland
          dnf -y copr enable erikreider/SwayNotificationCenter
          dnf -y copr enable codelovr/swayosd

      - name: Parse package upgrades (old -> new)
        id: upgrades
        shell: bash
        run: |
          set -euo pipefail

          # Detect whether updates exist (0=no updates, 100=updates available)
          if dnf -qy check-update; then
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
            {
              echo "### Fedora ${{ matrix.fedora }}"
              echo ""
              echo "_No updates available._"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          else
            code=$?
            if [ "$code" -ne 100 ]; then
              echo "dnf check-update failed with code $code" >&2
              exit "$code"
            fi
          fi

          echo "has_updates=true" >> "$GITHUB_OUTPUT"

          list_file="$(mktemp)"
          table_file="$(mktemp)"

          echo "### Fedora ${{ matrix.fedora }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "| Package | Installed | Candidate |" > "$table_file"
          echo "|---|---:|---:|" >> "$table_file"

          declare -A OLD NEW ARCHES

          # Use process substitution to avoid subshell so the associative arrays persist
          while read -r nevra newver; do
            pkg="${nevra%.*}"         # base name (strip trailing .arch)
            arch="${nevra##*.}"       # arch (x86_64, i686, noarch, etc.)

             # Query installed version for this specific NEVRA
            oldver="$(rpm -q --qf '%{VERSION}-%{RELEASE}\n' "${pkg}.${arch}" 2>/dev/null || echo '?')"

             # Store versions (usually identical across arches)
            OLD["$pkg"]="${OLD[$pkg]:-$oldver}"
            NEW["$pkg"]="$newver"

            # Safely read existing list (may be unset on first encounter)
            cur="${ARCHES[$pkg]-}"
            if [[ ",${cur}," != *",$arch,"* ]]; then
              ARCHES["$pkg"]="${cur:+${cur},}$arch"
            fi
          done < <(dnf -q list --upgrades | awk 'NR>1 {print $1, $2}')

           # Stable, sorted output by package name
          mapfile -t _keys < <(printf '%s\n' "${!NEW[@]}" | sort)

          for pkg in "${_keys[@]}"; do
            arches="${ARCHES[$pkg]}"
            label="$pkg (${arches})"
            old="${OLD[$pkg]}"
            new="${NEW[$pkg]}"

            printf '%s: %s -> %s\n' "$label" "$old" "$new" >> "$list_file"
            printf '| %s | %s | %s |\n' "$label" "$old" "$new" >> "$table_file"
          done
          
          {
            echo "upgrade_list<<EOF"
            cat "$list_file"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          cat "$table_file" >> "$GITHUB_STEP_SUMMARY"

      - name: Show concise list in logs
        if: steps.upgrades.outputs.has_updates == 'true'
        run: |
          echo "== Upgrades detected on Fedora ${{ matrix.fedora }} =="
          echo "${{ steps.upgrades.outputs.upgrade_list }}"

      - name: Security advisories (if any)
        if: steps.upgrades.outputs.has_updates == 'true'
        run: |
          echo ""
          echo "== Security update summary =="
          dnf -y updateinfo summary || true
          echo ""
          echo "== Security updates available =="
          dnf -y updateinfo list security --available || true

  build:
    name: Trigger build
    needs: check
    if: needs.check.outputs.has_updates == 'true'
    uses: ./.github/workflows/build.yml
    secrets: inherit

    permissions:
      contents: read
      packages: write
      id-token: write
